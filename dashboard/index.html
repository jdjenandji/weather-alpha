<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weather Alpha Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', system-ui, sans-serif; background: #0a0a0f; color: #e0e0e0; padding: 20px; }
  h1 { font-size: 1.4em; color: #fff; margin-bottom: 4px; }
  .subtitle { color: #666; font-size: 0.85em; margin-bottom: 20px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .card { background: #13131a; border: 1px solid #1e1e2e; border-radius: 12px; padding: 16px; }
  .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .city-name { font-weight: 600; font-size: 1.1em; }
  .date-badge { background: #1e1e2e; padding: 3px 10px; border-radius: 20px; font-size: 0.8em; color: #888; }
  .signal { padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-weight: 600; display: inline-block; margin-bottom: 10px; }
  .signal-strong { background: #0f3d0f; color: #4ade80; border: 1px solid #166534; }
  .signal-marginal { background: #3d3d0f; color: #facc15; border: 1px solid #854d0e; }
  .signal-skip { background: #2d1215; color: #f87171; border: 1px solid #7f1d1d; }
  .models { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 10px; }
  .model-box { background: #0a0a12; border-radius: 8px; padding: 8px; text-align: center; }
  .model-name { font-size: 0.7em; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
  .model-val { font-size: 1.2em; font-weight: 700; margin-top: 2px; }
  .model-bucket { font-size: 0.75em; color: #888; }
  .agree { color: #4ade80; }
  .disagree { color: #f87171; }
  .market-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #1a1a2a; font-size: 0.85em; }
  .market-row:last-child { border: none; }
  .market-row.target { background: #0f2d0f; margin: 0 -8px; padding: 4px 8px; border-radius: 4px; }
  .bar-container { width: 80px; height: 6px; background: #1a1a2a; border-radius: 3px; overflow: hidden; }
  .bar { height: 100%; border-radius: 3px; }
  .bar-green { background: #4ade80; }
  .bar-yellow { background: #facc15; }
  .bar-gray { background: #444; }
  .edge-box { margin-top: 10px; padding: 10px; background: #0a0a12; border-radius: 8px; display: flex; justify-content: space-between; gap: 12px; }
  .edge-label { font-size: 0.75em; color: #666; }
  .edge-value { font-size: 1.1em; font-weight: 700; }
  .edge-positive { color: #4ade80; }
  .edge-negative { color: #f87171; }
  .summary-bar { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
  .stat { background: #13131a; border: 1px solid #1e1e2e; border-radius: 10px; padding: 12px 20px; min-width: 120px; }
  .stat-label { font-size: 0.7em; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 1.4em; font-weight: 700; margin-top: 2px; }
  .refresh-btn { background: #1e1e2e; border: 1px solid #2e2e3e; color: #888; padding: 6px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85em; }
  .refresh-btn:hover { background: #2e2e3e; color: #fff; }
  .loading { color: #666; font-style: italic; }
  #lastUpdate { color: #444; font-size: 0.8em; }
  .section-title { font-size: 1em; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 1px; margin: 28px 0 12px; padding-bottom: 6px; border-bottom: 1px solid #1e1e2e; }
  .chart-container { background: #13131a; border: 1px solid #1e1e2e; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
  .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .chart-title { font-weight: 600; font-size: 1em; }
  .date-selector { display: flex; gap: 6px; }
  .date-btn { background: #1e1e2e; border: 1px solid #2e2e3e; color: #888; padding: 3px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8em; }
  .date-btn.active { background: #0f3d0f; color: #4ade80; border-color: #166534; }
  .chart-wrap { height: 250px; position: relative; }
  .no-data { color: #555; font-size: 0.85em; text-align: center; padding: 60px 0; }
  .tab-bar { display: flex; gap: 8px; margin-bottom: 16px; }
  .tab { background: #1e1e2e; border: 1px solid #2e2e3e; color: #888; padding: 6px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85em; }
  .tab.active { background: #0f3d0f; color: #4ade80; border-color: #166534; }
</style>
</head>
<body>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 4px;">
  <h1>ğŸŒ¡ï¸ Weather Alpha</h1>
  <button class="refresh-btn" onclick="refresh()">â†» Refresh</button>
</div>
<div class="subtitle">ECMWF IFS + Multi-Model Consensus Â· Polymarket Weather Markets Â· Tier 1 Only <span id="lastUpdate"></span></div>

<div class="summary-bar" id="summaryBar">
  <div class="stat"><div class="stat-label">Signals</div><div class="stat-value" id="signalCount">â€”</div></div>
  <div class="stat"><div class="stat-label">Strong</div><div class="stat-value edge-positive" id="strongCount">â€”</div></div>
  <div class="stat"><div class="stat-label">Marginal</div><div class="stat-value" style="color:#facc15" id="marginalCount">â€”</div></div>
  <div class="stat"><div class="stat-label">Best Edge</div><div class="stat-value edge-positive" id="bestEdge">â€”</div></div>
  <div class="stat"><div class="stat-label">Data Points</div><div class="stat-value" id="dataPoints">â€”</div></div>
</div>

<div class="tab-bar">
  <div class="tab active" onclick="switchTab('live')">ğŸ“¡ Live Signals</div>
  <div class="tab" onclick="switchTab('charts')">ğŸ“ˆ Delta Charts</div>
  <div class="tab" onclick="switchTab('trades')">ğŸ’° Trades</div>
  <div class="tab" onclick="switchTab('backtest')">ğŸ“Š Backtest</div>
  <div class="tab" onclick="switchTab('logic')">ğŸ§  Trading Logic</div>
</div>

<div id="liveTab">
  <div class="grid" id="dashboard">
    <div class="card"><div class="loading">Loading...</div></div>
  </div>
</div>

<div id="chartsTab" style="display:none">
  <div id="chartArea"></div>
</div>

<div id="logicTab" style="display:none">
  <div style="max-width:900px">

    <div class="card" style="margin-bottom:16px;border-left:3px solid #4ade80">
      <div style="font-size:1.2em;font-weight:700;margin-bottom:12px">ğŸ§  Trading Logic v2</div>
      <div style="font-size:0.85em;color:#888;margin-bottom:16px">Updated Feb 19 2026 â€” based on 90-day backtest (Nov 21 2025 â†’ Feb 17 2026)</div>

      <div style="background:#0a0a12;border-radius:8px;padding:16px;margin-bottom:16px">
        <div style="font-size:0.8em;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Core Rules</div>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:0.9em">
          <div>1ï¸âƒ£ <strong style="color:#4ade80">ECMWF must agree</strong> â€” If ECMWF disagrees with the consensus bucket, skip. ECMWF is the best model for all Tier 1 cities.</div>
          <div>2ï¸âƒ£ <strong style="color:#facc15">Per-city consensus threshold</strong> â€” London needs â‰¥2/3, Paris and Chicago need 3/3.</div>
          <div>3ï¸âƒ£ <strong style="color:#60a5fa">Edge > 15%</strong> â€” Model confidence minus market price must exceed 15% for a strong signal.</div>
          <div>4ï¸âƒ£ <strong style="color:#fb923c">One trade per city per date</strong> â€” No doubling down.</div>
          <div>5ï¸âƒ£ <strong style="color:#a78bfa">Monitor for shifts</strong> â€” If consensus breaks after entry, flag as BROKEN.</div>
        </div>
      </div>
    </div>

    <div style="font-size:0.8em;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #1e1e2e">Active Markets</div>
    <div class="grid" style="margin-bottom:16px">

      <div class="card" style="border-left:3px solid #4ade80">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span style="font-weight:700;font-size:1.1em">ğŸ‡¬ğŸ‡§ London</span>
          <span style="background:#0f3d0f;color:#4ade80;padding:3px 10px;border-radius:6px;font-size:0.8em;font-weight:600">PRIMARY</span>
        </div>
        <div style="font-size:0.85em;color:#aaa;margin-bottom:10px">Station: EGLC (London City Airport) Â· 1Â°C buckets</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">MIN CONSENSUS</div>
            <div style="font-size:1.3em;font-weight:700;color:#4ade80">â‰¥2/3</div>
          </div>
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">ECMWF ALONE</div>
            <div style="font-size:1.3em;font-weight:700;color:#4ade80">85%</div>
          </div>
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">â‰¥2/3 RATE</div>
            <div style="font-size:1.3em;font-weight:700;color:#4ade80">83%</div>
          </div>
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">3/3 RATE</div>
            <div style="font-size:1.3em;font-weight:700;color:#4ade80">90%</div>
          </div>
        </div>
        <div style="margin-top:10px;font-size:0.8em;color:#555">MAE: 0.17Â°C Â· Triggers 93% of days Â· Last 30d: 93% Â· Best market by far</div>
      </div>

      <div class="card" style="border-left:3px solid #60a5fa">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span style="font-weight:700;font-size:1.1em">ğŸ‡«ğŸ‡· Paris</span>
          <span style="background:#1e1e2e;color:#facc15;padding:3px 10px;border-radius:6px;font-size:0.8em;font-weight:600">3/3 ONLY</span>
        </div>
        <div style="font-size:0.85em;color:#aaa;margin-bottom:10px">Station: LFPG (CDG Airport) Â· 1Â°C buckets</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">MIN CONSENSUS</div>
            <div style="font-size:1.3em;font-weight:700;color:#facc15">3/3</div>
          </div>
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">ECMWF ALONE</div>
            <div style="font-size:1.3em;font-weight:700;color:#facc15">67%</div>
          </div>
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">â‰¥2/3 RATE</div>
            <div style="font-size:1.3em;font-weight:700;color:#f87171">65%</div>
          </div>
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">3/3 RATE</div>
            <div style="font-size:1.3em;font-weight:700;color:#facc15">75%</div>
          </div>
        </div>
        <div style="margin-top:10px;font-size:0.8em;color:#555">MAE: 0.29Â°C Â· 3/3 triggers 22% of days Â· Declining trend: Nov 86%â†’Feb 59%</div>
      </div>

      <div class="card" style="border-left:3px solid #facc15">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span style="font-weight:700;font-size:1.1em">ğŸ‡ºğŸ‡¸ Chicago</span>
          <span style="background:#1e1e2e;color:#facc15;padding:3px 10px;border-radius:6px;font-size:0.8em;font-weight:600">3/3 ONLY</span>
        </div>
        <div style="font-size:0.85em;color:#aaa;margin-bottom:10px">Station: KORD (O'Hare Airport) Â· 2Â°F buckets</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">MIN CONSENSUS</div>
            <div style="font-size:1.3em;font-weight:700;color:#facc15">3/3</div>
          </div>
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">ECMWF ALONE</div>
            <div style="font-size:1.3em;font-weight:700;color:#4ade80">79%</div>
          </div>
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">â‰¥2/3 RATE</div>
            <div style="font-size:1.3em;font-weight:700;color:#f87171">66%</div>
          </div>
          <div style="background:#0a0a12;border-radius:6px;padding:8px;text-align:center">
            <div style="font-size:0.7em;color:#666">3/3 RATE</div>
            <div style="font-size:1.3em;font-weight:700;color:#4ade80">83%</div>
          </div>
        </div>
        <div style="margin-top:10px;font-size:0.8em;color:#555">MAE: 0.42Â°F Â· 3/3 triggers 13% of days Â· GFS is terrible here (25% match)</div>
      </div>

    </div>

    <div style="font-size:0.8em;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #1e1e2e">Removed Markets</div>
    <div class="card" style="margin-bottom:16px;opacity:0.6">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-weight:700">ğŸ‡¦ğŸ‡· Buenos Aires</span>
        <span style="background:#2d1215;color:#f87171;padding:3px 10px;border-radius:6px;font-size:0.8em;font-weight:600">REMOVED</span>
      </div>
      <div style="font-size:0.85em;color:#666;margin-top:6px">60% consensus rate Â· 3/3 fires only 3% of days Â· GFS 21% match Â· Not tradeable</div>
    </div>

    <div style="font-size:0.8em;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #1e1e2e">Signal Flow</div>
    <div class="card" style="margin-bottom:16px">
      <div style="font-family:monospace;font-size:0.85em;line-height:2;color:#aaa">
        <div>â”Œâ”€ Fetch ECMWF, GFS, ICON forecasts</div>
        <div>â”œâ”€ Compute bucket for each model</div>
        <div>â”œâ”€ Find consensus bucket (most common)</div>
        <div>â”œâ”€ <span style="color:#f87171">ECMWF disagrees? â†’ SKIP</span></div>
        <div>â”œâ”€ <span style="color:#f87171">Below city minConsensus? â†’ SKIP</span></div>
        <div>â”œâ”€ Fetch Polymarket odds for consensus bucket</div>
        <div>â”œâ”€ Calculate edge = model_confidence âˆ’ market_price</div>
        <div>â”œâ”€ <span style="color:#f87171">Edge â‰¤ 15%? â†’ SKIP</span></div>
        <div>â”œâ”€ <span style="color:#f87171">Already traded this city+date? â†’ SKIP</span></div>
        <div>â”œâ”€ <span style="color:#4ade80">âœ… PAPER TRADE: BUY consensus bucket YES</span></div>
        <div>â”œâ”€ Every 15 min: monitor for forecast shifts</div>
        <div>â”‚  â”œâ”€ 3/3 still agree â†’ âœ… HOLDING</div>
        <div>â”‚  â”œâ”€ 2/3 agree â†’ âš ï¸ DRIFTING</div>
        <div>â”‚  â””â”€ Consensus flipped â†’ ğŸš¨ BROKEN</div>
        <div>â””â”€ Next day: auto-resolve via ERA5 archive â†’ WON/LOST + P&L</div>
      </div>
    </div>

    <div style="font-size:0.8em;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #1e1e2e">Key Learnings</div>
    <div class="card" style="margin-bottom:16px">
      <div style="display:flex;flex-direction:column;gap:12px;font-size:0.9em">
        <div>
          <div style="font-weight:600;color:#f87171;margin-bottom:2px">ğŸ“‰ 30-day backtests are misleading</div>
          <div style="color:#888">Paris went from 87% (30d) to 67% (90d). Always backtest with maximum available data.</div>
        </div>
        <div>
          <div style="font-weight:600;color:#4ade80;margin-bottom:2px">ğŸ† ECMWF is king, but not infallible</div>
          <div style="color:#888">Best model for all Tier 1 cities. But when ECMWF disagrees with consensus, it's often because ECMWF had an outlier run (see London Trade #1: 7.9Â°Câ†’7.2Â°C correction).</div>
        </div>
        <div>
          <div style="font-weight:600;color:#facc15;margin-bottom:2px">âš ï¸ GFS is unreliable outside Europe</div>
          <div style="color:#888">25% match in Chicago, 21% in Buenos Aires. GFS agreement only adds value in London (69%) and Paris (43%).</div>
        </div>
        <div>
          <div style="font-weight:600;color:#60a5fa;margin-bottom:2px">ğŸ¯ 3/3 consensus is the real signal</div>
          <div style="color:#888">London 90%, Chicago 83%, Paris 75%. But it fires rarely outside London. Quality over quantity.</div>
        </div>
        <div>
          <div style="font-weight:600;color:#a78bfa;margin-bottom:2px">ğŸ“Š Seasonality matters</div>
          <div style="color:#888">Paris accuracy declined from Nov (86%) to Feb (59%). Models struggle more with winter volatility.</div>
        </div>
        <div>
          <div style="font-weight:600;color:#f87171;margin-bottom:2px">ğŸš« Boundary filter doesn't work</div>
          <div style="color:#888">Filtering trades near bucket boundaries (Â±0.3Â°C) actually reduced accuracy. Removed from logic.</div>
        </div>
      </div>
    </div>

    <div style="font-size:0.8em;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #1e1e2e">Data Sources</div>
    <div class="card">
      <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 16px;font-size:0.85em">
        <span style="color:#666">Forecasts</span><span>Open-Meteo (ECMWF IFS 0.25Â°, GFS, ICON)</span>
        <span style="color:#666">Market data</span><span>Polymarket Gamma API</span>
        <span style="color:#666">Resolution</span><span>Weather Underground (airport METAR stations)</span>
        <span style="color:#666">Backtest actuals</span><span>ERA5 reanalysis (proxy for WU, small delta possible)</span>
        <span style="color:#666">ECMWF schedule</span><span>00z available ~05:30 UTC Â· 12z available ~17:30 UTC</span>
        <span style="color:#666">Collection interval</span><span>Every 15 minutes via Railway cron</span>
      </div>
    </div>

  </div>
</div>

<div id="backtestTab" style="display:none">
  <div id="backtestArea"><div class="card"><div class="loading">Loading...</div></div></div>
</div>

<div id="tradesTab" style="display:none">
  <div id="tradesStats" class="summary-bar" style="margin-bottom:16px"></div>
  <div id="tradesArea">
    <div class="card"><div class="loading">Loading trades...</div></div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://jbqkskwfjbejixyiuqpn.supabase.co';
const SUPABASE_KEY = 'sb_publishable_6TopOsnadhqteb8xltZiZw_epDDV-cm';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const CITIES = [
  { name: "London", slug: "london", unit: "C", conf2: 0.83, conf3: 0.90, minConsensus: 2, tier: 'primary', flag: 'ğŸ‡¬ğŸ‡§' },
  { name: "Paris", slug: "paris", unit: "C", conf2: 0.65, conf3: 0.75, minConsensus: 3, tier: 'secondary', flag: 'ğŸ‡«ğŸ‡·' },
  { name: "Chicago", slug: "chicago", unit: "F", conf2: 0.66, conf3: 0.83, minConsensus: 3, tier: 'secondary', flag: 'ğŸ‡ºğŸ‡¸' },
];

const charts = {};
let currentTab = 'live';

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
  document.getElementById('liveTab').style.display = tab === 'live' ? '' : 'none';
  document.getElementById('chartsTab').style.display = tab === 'charts' ? '' : 'none';
  document.getElementById('tradesTab').style.display = tab === 'trades' ? '' : 'none';
  document.getElementById('backtestTab').style.display = tab === 'backtest' ? '' : 'none';
  document.getElementById('logicTab').style.display = tab === 'logic' ? '' : 'none';
  if (tab === 'charts') loadCharts();
  if (tab === 'trades') loadTrades();
  if (tab === 'backtest') loadBacktest();
}

function getBucket(val, unit) {
  if (unit === "F") { const b = Math.floor(val / 2) * 2; return `${b} to ${b+1}Â°F`; }
  return `${Math.round(val)}Â°C`;
}

function formatPolymarketDate(dateStr) {
  const d = new Date(dateStr + "T00:00:00Z");
  const months = ['january','february','march','april','may','june','july','august','september','october','november','december'];
  return `${months[d.getUTCMonth()]}-${d.getUTCDate()}-${d.getUTCFullYear()}`;
}

function getDates() {
  const dates = [];
  for (let i = 0; i <= 2; i++) {
    const d = new Date(); d.setUTCDate(d.getUTCDate() + i);
    dates.push(d.toISOString().slice(0, 10));
  }
  return dates;
}

async function fetchForecasts(city, dateStr) {
  const u = city.unit === "F" ? "&temperature_unit=fahrenheit" : "";
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat || CITIES.find(c=>c.slug===city.slug)?.lat}&longitude=${city.lon || CITIES.find(c=>c.slug===city.slug)?.lon}&daily=temperature_2m_max&timezone=UTC&start_date=${dateStr}&end_date=${dateStr}&models=ecmwf_ifs025,gfs_seamless,icon_seamless${u}`;
  const data = await (await fetch(url)).json();
  const result = {};
  for (const [k, v] of Object.entries(data.daily || {})) {
    if (k.startsWith("temperature_2m_max_")) {
      let model = k.replace("temperature_2m_max_", "").replace("_seamless", "").replace("_ifs025", "");
      if (v[0] != null) result[model] = v[0];
    }
  }
  return result;
}

const CITY_COORDS = {
  "london": { lat: 51.5053, lon: 0.0553 },
  "paris": { lat: 49.0097, lon: 2.5479 },
  "chicago": { lat: 41.9742, lon: -87.9073 },
};

async function fetchForecastsLive(slug, unit, dateStr) {
  const c = CITY_COORDS[slug];
  const u = unit === "F" ? "&temperature_unit=fahrenheit" : "";
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&daily=temperature_2m_max&timezone=UTC&start_date=${dateStr}&end_date=${dateStr}&models=ecmwf_ifs025,gfs_seamless,icon_seamless${u}`;
  const data = await (await fetch(url)).json();
  const result = {};
  for (const [k, v] of Object.entries(data.daily || {})) {
    if (k.startsWith("temperature_2m_max_")) {
      let model = k.replace("temperature_2m_max_", "").replace("_seamless", "").replace("_ifs025", "");
      if (v[0] != null) result[model] = v[0];
    }
  }
  return result;
}

async function fetchMarketLive(slug, dateStr) {
  // Try Polymarket API directly first
  const fmtDate = formatPolymarketDate(dateStr);
  const eventSlug = `highest-temperature-in-${slug}-on-${fmtDate}`;
  try {
    const data = await (await fetch(`https://gamma-api.polymarket.com/events?slug=${eventSlug}`)).json();
    if (data[0]) {
      return data[0].markets.map(m => ({
        title: m.groupItemTitle,
        price: parseFloat(JSON.parse(m.outcomePrices)[0]),
        volume: parseFloat(m.volume || "0"),
      })).sort((a, b) => b.price - a.price);
    }
  } catch { /* CORS or network error â€” fall through to Supabase */ }

  // Fallback: read latest market prices from Supabase (written by collector)
  try {
    const { data: rows } = await sb
      .from('market_prices')
      .select('bucket, price, volume, collected_at')
      .eq('city', slug)
      .eq('target_date', dateStr)
      .order('collected_at', { ascending: false })
      .limit(50);
    if (!rows || rows.length === 0) return null;
    // Get only the latest collection timestamp's data
    const latestTs = rows[0].collected_at;
    const latest = rows.filter(r => r.collected_at === latestTs);
    return latest.map(r => ({
      title: r.bucket,
      price: r.price,
      volume: r.volume || 0,
    })).sort((a, b) => b.price - a.price);
  } catch { return null; }
}

function renderCard(city, dateStr, forecasts, market) {
  const u = city.unit === "F" ? "Â°F" : "Â°C";
  const models = Object.entries(forecasts).filter(([k,v]) => v != null);

  // Build model â†’ bucket map
  const modelBuckets = {};
  models.forEach(([k,v]) => modelBuckets[k] = getBucket(v, city.unit));
  const buckets = Object.values(modelBuckets);

  const bucketCounts = {};
  buckets.forEach(b => bucketCounts[b] = (bucketCounts[b] || 0) + 1);
  const consBucket = Object.entries(bucketCounts).sort((a,b) => b[1] - a[1])[0];
  const consensus = consBucket ? consBucket[0] : null;
  const agreement = consBucket ? consBucket[1] : 0;

  // v2 logic: ECMWF must agree + per-city consensus threshold
  const ecmwfBucket = modelBuckets.ecmwf;
  const ecmwfAgrees = ecmwfBucket === consensus;
  const meetsThreshold = agreement >= (city.minConsensus || 2);
  const tradeable = ecmwfAgrees && meetsThreshold;

  const modelConf = agreement >= 3 ? city.conf3 : agreement >= 2 ? city.conf2 : 0;
  const targetMarket = market?.find(m => m.title === consensus);
  const edge = targetMarket && tradeable ? modelConf - targetMarket.price : 0;

  // Signal determination
  let signalClass, signalText;
  if (!ecmwfAgrees && agreement >= 2) {
    signalClass = "signal-skip"; signalText = `â›” ECMWF DISAGREES`;
  } else if (!meetsThreshold) {
    signalClass = "signal-skip"; signalText = agreement < 2 ? `âŒ NO CONSENSUS` : `âŒ NEED ${city.minConsensus}/3 (got ${agreement}/3)`;
  } else if (edge > 0.15) {
    signalClass = "signal-strong"; signalText = `ğŸ”¥ STRONG (${agreement}/3)`;
  } else if (edge > 0.05) {
    signalClass = "signal-marginal"; signalText = `âš ï¸ MARGINAL (${agreement}/3)`;
  } else {
    signalClass = "signal-skip"; signalText = `âŒ NO EDGE`;
  }

  const now = new Date();
  const ts = now.toLocaleString('en-GB', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'UTC' }) + ' UTC';
  const marketOdds = targetMarket ? `${(targetMarket.price*100).toFixed(1)}Â¢` : 'â€”';
  const topMarket = market?.[0];
  const topOdds = topMarket ? `${topMarket.title} @ ${(topMarket.price*100).toFixed(1)}Â¢` : '';
  const tierBadge = city.tier === 'primary'
    ? `<span style="background:#0f3d0f;color:#4ade80;padding:1px 6px;border-radius:4px;font-size:0.7em;margin-left:6px">PRIMARY</span>`
    : `<span style="background:#1e1e2e;color:#888;padding:1px 6px;border-radius:4px;font-size:0.7em;margin-left:6px">${city.minConsensus}/3 REQ</span>`;

  let html = `<div class="card">
    <div class="card-header"><span class="city-name">${city.flag || ''} ${city.name}${tierBadge}</span><span class="date-badge">${dateStr}</span></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <span class="signal ${signalClass}" style="margin-bottom:0">${signalText}</span>
      <span style="font-size:0.7em;color:#555">ğŸ• ${ts}</span>
    </div>
    <div style="display:flex;gap:12px;margin-bottom:10px;padding:8px;background:#0a0a12;border-radius:8px;font-size:0.85em">
      <div style="flex:1"><span style="color:#666;font-size:0.8em">CONSENSUS</span><div style="font-weight:700;color:${tradeable?'#4ade80':'#555'}">${consensus || 'None'}</div></div>
      <div style="flex:1"><span style="color:#666;font-size:0.8em">MARKET ODDS</span><div style="font-weight:700;color:#60a5fa">${tradeable ? marketOdds : 'â€”'}</div></div>
      <div style="flex:1"><span style="color:#666;font-size:0.8em">FAVORITE</span><div style="font-weight:700;color:#facc15">${topOdds || 'â€”'}</div></div>
    </div>
    <div class="models">`;
  for (const [model, val] of models) {
    const bucket = getBucket(val, city.unit);
    const isCons = bucket === consensus;
    const isEcmwf = model === 'ecmwf';
    const border = isEcmwf ? 'border:1px solid #4ade8044;' : '';
    html += `<div class="model-box" style="${border}"><div class="model-name">${model}${isEcmwf ? ' â˜…' : ''}</div><div class="model-val ${isCons?'agree':'disagree'}">${val.toFixed(1)}${u}</div><div class="model-bucket ${isCons?'agree':'disagree'}">â†’ ${bucket}</div></div>`;
  }
  html += `</div>`;

  // ECMWF check banner
  if (!ecmwfAgrees && agreement >= 2) {
    html += `<div style="background:#2d1215;border:1px solid #7f1d1d;border-radius:6px;padding:8px;margin-bottom:8px;font-size:0.8em;color:#f87171">â›” ECMWF forecasts <strong>${ecmwfBucket}${u}</strong> but consensus is <strong>${consensus}${u}</strong> â€” trade blocked per v2 rules</div>`;
  }

  if (market) {
    html += `<div style="font-size:0.75em;color:#555;margin-bottom:4px">MARKET PRICES</div>`;
    for (const m of market.slice(0, 5)) {
      const isTarget = targetMarket && m.title === targetMarket.title;
      const barColor = isTarget ? (edge > 0.15 ? 'bar-green' : edge > 0 ? 'bar-yellow' : 'bar-gray') : 'bar-gray';
      html += `<div class="market-row ${isTarget ? 'target' : ''}"><span>${m.title}</span><div style="display:flex;align-items:center;gap:8px"><div class="bar-container"><div class="bar ${barColor}" style="width:${m.price*100}%"></div></div><span style="width:40px;text-align:right">${(m.price*100).toFixed(1)}%</span></div></div>`;
    }
  } else {
    html += `<div style="color:#555;font-size:0.85em">No market found</div>`;
  }

  if (targetMarket && tradeable) {
    html += `<div class="edge-box"><div><div class="edge-label">TARGET</div><div>${targetMarket.title} @ ${(targetMarket.price*100).toFixed(1)}Â¢</div></div><div><div class="edge-label">MODEL CONF</div><div>${(modelConf*100).toFixed(0)}%</div></div><div><div class="edge-label">EDGE</div><div class="edge-value ${edge > 0 ? 'edge-positive' : 'edge-negative'}">${edge > 0 ? '+' : ''}${(edge*100).toFixed(1)}%</div></div></div>`;
  }
  html += `</div>`;
  return { html, signal: signalClass.includes("strong") ? "strong" : signalClass.includes("marginal") ? "marginal" : "skip", edge };
}

async function refresh() {
  const dashboard = document.getElementById("dashboard");
  dashboard.innerHTML = '<div class="card"><div class="loading">Fetching live data...</div></div>';

  const dates = getDates();
  let cards = [];
  let strong = 0, marginal = 0, bestEdge = 0;

  for (const dateStr of dates) {
    for (const city of CITIES) {
      try {
        const [forecasts, market] = await Promise.all([
          fetchForecastsLive(city.slug, city.unit, dateStr),
          fetchMarketLive(city.slug, dateStr),
        ]);
        const result = renderCard(city, dateStr, forecasts, market);
        cards.push(result);
        if (result.signal === "strong") strong++;
        if (result.signal === "marginal") marginal++;
        if (result.edge > bestEdge) bestEdge = result.edge;
      } catch (e) {
        cards.push({ html: `<div class="card"><div class="city-name">${city.name} â€” ${dateStr}</div><div style="color:#f87171">${e.message}</div></div>`, signal: "skip", edge: 0 });
      }
    }
  }

  const order = { strong: 0, marginal: 1, skip: 2 };
  cards.sort((a, b) => order[a.signal] - order[b.signal]);
  dashboard.innerHTML = cards.map(c => c.html).join("");

  document.getElementById("signalCount").textContent = cards.length;
  document.getElementById("strongCount").textContent = strong;
  document.getElementById("marginalCount").textContent = marginal;
  document.getElementById("bestEdge").textContent = bestEdge > 0 ? `+${(bestEdge*100).toFixed(0)}%` : "â€”";
  document.getElementById("lastUpdate").textContent = `| Updated ${new Date().toLocaleTimeString()}`;

  // Check data points in supabase
  const { count } = await sb.from('forecasts').select('*', { count: 'exact', head: true });
  document.getElementById("dataPoints").textContent = count ?? 0;
}

// Extract temperature from bucket label: "8Â°C" -> 8, "52 to 53Â°F" -> 52.5
function bucketToTemp(bucket) {
  if (!bucket) return null;
  const cMatch = bucket.match(/^(-?\d+)Â°C$/);
  if (cMatch) return parseInt(cMatch[1]);
  const fMatch = bucket.match(/^(-?\d+)\s*to\s*(-?\d+)Â°F$/);
  if (fMatch) return (parseInt(fMatch[1]) + parseInt(fMatch[2])) / 2;
  return null;
}

async function loadCharts() {
  const area = document.getElementById("chartArea");
  area.innerHTML = '<div class="loading" style="padding:40px;text-align:center">Loading historical data...</div>';

  const dates = getDates();
  let html = '';

  for (const city of CITIES) {
    html += `<div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">${city.name} â€” Forecast vs Market Favorite</span>
        <div class="date-selector" id="dates-${city.slug}">
          ${dates.map((d, i) => `<button class="date-btn ${i===1?'active':''}" onclick="loadCityChart('${city.slug}','${d}',this)">${d}</button>`).join('')}
        </div>
      </div>
      <div class="chart-wrap"><canvas id="chart-${city.slug}"></canvas></div>
    </div>`;
  }
  area.innerHTML = html;

  for (const city of CITIES) {
    await loadCityChart(city.slug, dates[1]);
  }
}

async function loadCityChart(slug, targetDate, btn) {
  if (btn) {
    btn.parentElement.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  const city = CITIES.find(c => c.slug === slug);
  const unit = city.unit === "F" ? "Â°F" : "Â°C";
  const canvasId = `chart-${slug}`;

  // Fetch ECMWF forecasts over time from Supabase
  const { data: fcRows } = await sb
    .from('forecasts')
    .select('model, temp_value, collected_at')
    .eq('city', slug)
    .eq('target_date', targetDate)
    .eq('model', 'ecmwf')
    .order('collected_at', { ascending: true });

  // Fetch market prices over time â€” we need the favorite (highest priced bucket) at each collection
  const { data: mkRows } = await sb
    .from('market_prices')
    .select('bucket, price, collected_at')
    .eq('city', slug)
    .eq('target_date', targetDate)
    .order('collected_at', { ascending: true });

  if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; }

  const canvas = document.getElementById(canvasId);
  if (!canvas) return;

  if ((!fcRows || fcRows.length === 0) && (!mkRows || mkRows.length === 0)) {
    canvas.parentElement.innerHTML = `<div class="no-data">No historical data yet for ${targetDate}. Collector needs to run first.</div>`;
    return;
  }

  // ECMWF forecast temp over time
  const forecastData = (fcRows || []).map(r => ({
    x: new Date(r.collected_at),
    y: r.temp_value
  }));

  // Market favorite: group by collected_at, pick highest-priced bucket, extract its temp
  const byTime = {};
  (mkRows || []).forEach(r => {
    const t = r.collected_at;
    if (!byTime[t] || r.price > byTime[t].price) {
      byTime[t] = { bucket: r.bucket, price: r.price };
    }
  });
  const favoriteData = Object.entries(byTime)
    .map(([t, v]) => ({ x: new Date(t), y: bucketToTemp(v.bucket) }))
    .filter(d => d.y != null);

  const datasets = [
    {
      label: 'ECMWF Forecast',
      data: forecastData,
      borderColor: '#4ade80',
      backgroundColor: 'rgba(74,222,128,0.1)',
      borderWidth: 2.5,
      pointRadius: 4,
      pointBackgroundColor: '#4ade80',
      fill: false,
      tension: 0.3,
    },
    {
      label: 'Market Favorite',
      data: favoriteData,
      borderColor: '#60a5fa',
      backgroundColor: 'rgba(96,165,250,0.1)',
      borderWidth: 2.5,
      pointRadius: 4,
      pointBackgroundColor: '#60a5fa',
      pointStyle: 'rectRot',
      fill: false,
      tension: 0.3,
    },
  ];

  // Add shaded area between the two lines if they diverge
  if (forecastData.length > 0 && favoriteData.length > 0) {
    // Determine y-axis range
    const allY = [...forecastData.map(d => d.y), ...favoriteData.map(d => d.y)];
    var yMin = Math.floor(Math.min(...allY) - 2);
    var yMax = Math.ceil(Math.max(...allY) + 2);
  }

  charts[canvasId] = new Chart(canvas, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#888', font: { size: 11 } } },
        tooltip: {
          backgroundColor: '#1e1e2e',
          titleColor: '#fff',
          bodyColor: '#ccc',
          borderColor: '#2e2e3e',
          borderWidth: 1,
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}${unit}`
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: { tooltipFormat: 'MMM d, HH:mm', displayFormats: { hour: 'HH:mm', day: 'MMM d' } },
          title: { display: true, text: 'Time (UTC)', color: '#666' },
          ticks: { color: '#555' },
          grid: { color: '#1a1a2a' },
        },
        y: {
          position: 'left',
          min: yMin ?? undefined,
          max: yMax ?? undefined,
          title: { display: true, text: `Temperature (${unit})`, color: '#666' },
          ticks: { color: '#555', callback: v => v + unit },
          grid: { color: '#1a1a2a' },
        }
      }
    }
  });
}

async function loadTrades() {
  const area = document.getElementById("tradesArea");
  const stats = document.getElementById("tradesStats");
  area.innerHTML = '<div class="card"><div class="loading">Loading trades...</div></div>';

  const { data: trades, error } = await sb
    .from('trades')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(100);

  if (error || !trades) {
    area.innerHTML = '<div class="card"><div style="color:#f87171">Error loading trades</div></div>';
    return;
  }

  if (trades.length === 0) {
    stats.innerHTML = '';
    area.innerHTML = '<div class="card"><div class="no-data">No trades yet. Bot will auto-trade on strong signals when POLY_ENABLED=true.</div></div>';
    return;
  }

  // Fetch current market prices for open trades
  const openTrades = trades.filter(t => t.status === 'open');
  const currentPrices = {};
  for (const t of openTrades) {
    const key = `${t.city}:${t.target_date}`;
    if (currentPrices[key]) continue;
    const market = await fetchMarketLive(t.city, t.target_date);
    if (market) {
      currentPrices[key] = {};
      market.forEach(m => currentPrices[key][m.title] = m.price);
    }
  }

  // Attach current price + unrealized P&L to each trade
  for (const t of trades) {
    if (t.status === 'open') {
      const key = `${t.city}:${t.target_date}`;
      t._currentPrice = currentPrices[key]?.[t.bucket] ?? null;
      t._unrealizedPnl = t._currentPrice != null ? +((t._currentPrice - t.price) * t.shares).toFixed(2) : null;
    } else {
      t._currentPrice = null;
      t._unrealizedPnl = null;
    }
  }

  // Compute stats
  const totalCost = trades.reduce((s, t) => s + (t.cost || 0), 0);
  const wins = trades.filter(t => t.status === 'won');
  const losses = trades.filter(t => t.status === 'lost');
  const open = openTrades;
  const realizedPnl = trades.reduce((s, t) => s + (t.pnl || 0), 0);
  const unrealizedPnl = trades.reduce((s, t) => s + (t._unrealizedPnl || 0), 0);
  const totalPnl = realizedPnl + unrealizedPnl;
  const winRate = (wins.length + losses.length) > 0 ? (wins.length / (wins.length + losses.length) * 100).toFixed(0) : 'â€”';

  stats.innerHTML = `
    <div class="stat"><div class="stat-label">Total Trades</div><div class="stat-value">${trades.length}</div></div>
    <div class="stat"><div class="stat-label">Open</div><div class="stat-value" style="color:#60a5fa">${open.length}</div></div>
    <div class="stat"><div class="stat-label">Won</div><div class="stat-value edge-positive">${wins.length}</div></div>
    <div class="stat"><div class="stat-label">Lost</div><div class="stat-value edge-negative">${losses.length}</div></div>
    <div class="stat"><div class="stat-label">Win Rate</div><div class="stat-value" style="color:#facc15">${winRate}%</div></div>
    <div class="stat"><div class="stat-label">Deployed</div><div class="stat-value">$${totalCost.toFixed(2)}</div></div>
    <div class="stat"><div class="stat-label">Realized</div><div class="stat-value ${realizedPnl >= 0 ? 'edge-positive' : 'edge-negative'}">${realizedPnl >= 0 ? '+' : ''}$${realizedPnl.toFixed(2)}</div></div>
    <div class="stat"><div class="stat-label">Unrealized</div><div class="stat-value ${unrealizedPnl >= 0 ? 'edge-positive' : 'edge-negative'}">${unrealizedPnl >= 0 ? '+' : ''}$${unrealizedPnl.toFixed(2)}</div></div>
    <div class="stat"><div class="stat-label">Total P&L</div><div class="stat-value ${totalPnl >= 0 ? 'edge-positive' : 'edge-negative'}">${totalPnl >= 0 ? '+' : ''}$${totalPnl.toFixed(2)}</div></div>
  `;

  // Render trade rows
  let html = `<div class="card" style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:0.85em">
    <thead><tr style="border-bottom:1px solid #2e2e3e;text-align:left">
      <th style="padding:8px;color:#666">Time</th>
      <th style="padding:8px;color:#666">City</th>
      <th style="padding:8px;color:#666">Date</th>
      <th style="padding:8px;color:#666">Bucket</th>
      <th style="padding:8px;color:#666">Entry</th>
      <th style="padding:8px;color:#666">Now</th>
      <th style="padding:8px;color:#666">Shares</th>
      <th style="padding:8px;color:#666">Cost</th>
      <th style="padding:8px;color:#666">Edge</th>
      <th style="padding:8px;color:#666">Status</th>
      <th style="padding:8px;color:#666">P&L</th>
    </tr></thead><tbody>`;

  for (const t of trades) {
    const time = new Date(t.created_at).toLocaleString('en-GB', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'UTC' });
    const cityName = CITIES.find(c => c.slug === t.city)?.name || t.city;
    const statusColor = t.status === 'won' ? '#4ade80' : t.status === 'lost' ? '#f87171' : '#60a5fa';
    const statusIcon = t.status === 'won' ? 'âœ…' : t.status === 'lost' ? 'âŒ' : 'â³';
    // P&L: use realized for resolved trades, unrealized for open
    const displayPnl = t.pnl != null ? t.pnl : t._unrealizedPnl;
    const pnl = displayPnl != null ? `${displayPnl >= 0 ? '+' : ''}$${displayPnl.toFixed(2)}` : 'â€”';
    const pnlColor = displayPnl != null ? (displayPnl >= 0 ? '#4ade80' : '#f87171') : '#555';

    // Current price
    const currentPrice = t._currentPrice != null ? `${(t._currentPrice*100).toFixed(1)}Â¢` : 'â€”';
    const priceChange = t._currentPrice != null ? t._currentPrice - t.price : null;
    const nowColor = priceChange != null ? (priceChange >= 0 ? '#4ade80' : '#f87171') : '#555';

    html += `<tr style="border-bottom:1px solid #1a1a2a">
      <td style="padding:8px;color:#888">${time}</td>
      <td style="padding:8px;font-weight:600">${cityName}</td>
      <td style="padding:8px;color:#888">${t.target_date}</td>
      <td style="padding:8px"><span style="background:#1e1e2e;padding:2px 8px;border-radius:4px">${t.bucket}</span></td>
      <td style="padding:8px">${(t.price*100).toFixed(1)}Â¢</td>
      <td style="padding:8px;color:${nowColor};font-weight:600">${currentPrice}</td>
      <td style="padding:8px">${t.shares?.toFixed(1)}</td>
      <td style="padding:8px">$${t.cost?.toFixed(2)}</td>
      <td style="padding:8px;color:${t.edge > 0.15 ? '#4ade80' : '#facc15'}">${t.edge != null ? '+' + (t.edge*100).toFixed(0) + '%' : 'â€”'}</td>
      <td style="padding:8px;color:${statusColor}">${statusIcon} ${t.status}</td>
      <td style="padding:8px;color:${pnlColor};font-weight:600">${pnl}</td>
    </tr>`;
  }

  html += '</tbody></table></div>';

  // Load alerts for open trades
  const openIds = trades.filter(t => t.status === 'open').map(t => t.id);
  if (openIds.length > 0) {
    const { data: alerts } = await sb
      .from('trade_alerts')
      .select('*')
      .in('trade_id', openIds)
      .order('created_at', { ascending: false })
      .limit(50);

    if (alerts && alerts.length > 0) {
      // Group by trade, show latest per trade
      const latestByTrade = {};
      alerts.forEach(a => { if (!latestByTrade[a.trade_id]) latestByTrade[a.trade_id] = a; });

      html += '<div style="margin-top:16px"><div style="font-size:0.75em;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #1e1e2e">ğŸ“¡ Forecast Monitor</div>';
      for (const a of Object.values(latestByTrade)) {
        const cityName = CITIES.find(c => c.slug === a.city)?.name || a.city;
        const time = new Date(a.created_at).toLocaleString('en-GB', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'UTC' });
        const stateColor = a.state === 'holding' ? '#4ade80' : a.state === 'drifting' ? '#facc15' : '#f87171';
        const stateBg = a.state === 'holding' ? '#0f3d0f' : a.state === 'drifting' ? '#3d3d0f' : '#3d0f0f';
        html += `<div class="card" style="margin-bottom:8px;padding:12px;border-left:3px solid ${stateColor}">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${cityName}</strong> ${a.target_date} â€” <span style="background:${stateBg};color:${stateColor};padding:2px 8px;border-radius:4px;font-size:0.8em">${a.state.toUpperCase()}</span></div>
            <span style="font-size:0.7em;color:#555">${time} UTC</span>
          </div>
          <div style="margin-top:6px;font-size:0.85em;color:#aaa">${a.detail}</div>
          <div style="margin-top:4px;font-size:0.75em;color:#555">${a.model_detail}</div>
        </div>`;
      }
      html += '</div>';
    }
  }

  area.innerHTML = html;
}

let backtestCharts = {};

async function loadBacktest(runId) {
  const area = document.getElementById("backtestArea");
  area.innerHTML = '<div class="card"><div class="loading">Loading backtest data...</div></div>';

  // Get available runs
  const { data: summaries } = await sb
    .from('backtest_summary')
    .select('*')
    .order('created_at', { ascending: false });

  if (!summaries || summaries.length === 0) {
    area.innerHTML = '<div class="card"><div class="no-data">No backtest data yet. Run the backtest script first.</div></div>';
    return;
  }

  // Get unique run IDs
  const runs = [...new Set(summaries.map(s => s.run_id))];
  const selectedRun = runId || runs[0];
  const runSummaries = summaries.filter(s => s.run_id === selectedRun);

  // Fetch daily results for this run
  const { data: results } = await sb
    .from('backtest_results')
    .select('*')
    .eq('run_id', selectedRun)
    .order('target_date', { ascending: true });

  let html = '';

  // Run selector
  html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <div style="font-size:1.1em;font-weight:600">Backtest: ${selectedRun}</div>
    <select onchange="loadBacktest(this.value)" style="background:#1e1e2e;color:#e0e0e0;border:1px solid #2e2e3e;padding:6px 12px;border-radius:8px;font-size:0.85em">
      ${runs.map(r => `<option value="${r}" ${r===selectedRun?'selected':''}>${r}</option>`).join('')}
    </select>
  </div>`;

  // Summary cards
  html += '<div class="grid">';
  const cityColors = { paris: '#60a5fa', london: '#4ade80', chicago: '#facc15', 'buenos-aires': '#fb923c' };

  for (const s of runSummaries) {
    const cityName = CITIES.find(c => c.slug === s.city)?.name || s.city;
    const col = cityColors[s.city] || '#888';

    html += `<div class="card">
      <div class="card-header">
        <span class="city-name" style="border-left:3px solid ${col};padding-left:8px">${cityName}</span>
        <span class="date-badge">${s.days} days</span>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:12px">
        <div style="flex:1;background:#0a0a12;border-radius:8px;padding:10px;text-align:center">
          <div style="font-size:0.7em;color:#666;text-transform:uppercase">â‰¥2/3 Consensus</div>
          <div style="font-size:1.6em;font-weight:700;color:${s.consensus2_rate > 0.75 ? '#4ade80' : s.consensus2_rate > 0.6 ? '#facc15' : '#f87171'}">${(s.consensus2_rate*100).toFixed(0)}%</div>
          <div style="font-size:0.75em;color:#555">${s.consensus2_correct}/${s.consensus2_total}</div>
        </div>
        <div style="flex:1;background:#0a0a12;border-radius:8px;padding:10px;text-align:center">
          <div style="font-size:0.7em;color:#666;text-transform:uppercase">3/3 Consensus</div>
          <div style="font-size:1.6em;font-weight:700;color:${s.consensus3_rate > 0.8 ? '#4ade80' : s.consensus3_rate > 0.65 ? '#facc15' : '#f87171'}">${s.consensus3_total > 0 ? (s.consensus3_rate*100).toFixed(0) : 'â€”'}%</div>
          <div style="font-size:0.75em;color:#555">${s.consensus3_correct}/${s.consensus3_total}</div>
        </div>
      </div>

      <div style="font-size:0.75em;color:#555;margin-bottom:6px">MODEL ACCURACY</div>
      ${renderModelBar('ECMWF', s.ecmwf_match_rate, s.ecmwf_mae, '#4ade80')}
      ${renderModelBar('GFS', s.gfs_match_rate, s.gfs_mae, '#60a5fa')}
      ${renderModelBar('ICON', s.icon_match_rate, s.icon_mae, '#facc15')}
    </div>`;
  }
  html += '</div>';

  // Charts section
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
    <div class="chart-container">
      <div class="chart-title" style="margin-bottom:12px">Model Accuracy by City</div>
      <div style="height:280px"><canvas id="bt-accuracy-chart"></canvas></div>
    </div>
    <div class="chart-container">
      <div class="chart-title" style="margin-bottom:12px">Monthly Consensus Accuracy</div>
      <div style="height:280px"><canvas id="bt-monthly-chart"></canvas></div>
    </div>
  </div>`;

  // Daily results table
  html += `<div class="card" style="margin-top:16px;overflow-x:auto">
    <div style="font-size:0.75em;color:#555;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Daily Results (${results?.length || 0} days)</div>
    <div style="max-height:500px;overflow-y:auto">
    <table style="width:100%;border-collapse:collapse;font-size:0.8em">
      <thead style="position:sticky;top:0;background:#13131a"><tr style="border-bottom:1px solid #2e2e3e;text-align:left">
        <th style="padding:6px;color:#666">Date</th>
        <th style="padding:6px;color:#666">City</th>
        <th style="padding:6px;color:#666">Actual</th>
        <th style="padding:6px;color:#666">ECMWF</th>
        <th style="padding:6px;color:#666">GFS</th>
        <th style="padding:6px;color:#666">ICON</th>
        <th style="padding:6px;color:#666">Consensus</th>
        <th style="padding:6px;color:#666">Result</th>
      </tr></thead><tbody>`;

  for (const r of (results || []).reverse()) {
    const cityName = CITIES.find(c => c.slug === r.city)?.name || r.city;
    const ecmwfColor = r.ecmwf_match ? '#4ade80' : '#f87171';
    const gfsColor = r.gfs_match ? '#4ade80' : '#f87171';
    const iconColor = r.icon_match ? '#4ade80' : '#f87171';
    const consColor = r.consensus_correct ? '#4ade80' : '#f87171';
    const consIcon = r.consensus_correct ? 'âœ…' : 'âŒ';

    html += `<tr style="border-bottom:1px solid #1a1a2a">
      <td style="padding:6px;color:#888">${r.target_date}</td>
      <td style="padding:6px">${cityName}</td>
      <td style="padding:6px;font-weight:600">${r.actual_temp?.toFixed(1)} â†’ ${r.actual_bucket}</td>
      <td style="padding:6px;color:${ecmwfColor}">${r.ecmwf_temp?.toFixed(1)} â†’ ${r.ecmwf_bucket}</td>
      <td style="padding:6px;color:${gfsColor}">${r.gfs_temp?.toFixed(1)} â†’ ${r.gfs_bucket}</td>
      <td style="padding:6px;color:${iconColor}">${r.icon_temp?.toFixed(1)} â†’ ${r.icon_bucket}</td>
      <td style="padding:6px"><span style="background:${r.consensus_count >= 3 ? '#0f3d0f' : r.consensus_count >= 2 ? '#3d3d0f' : '#2d1215'};color:${r.consensus_count >= 3 ? '#4ade80' : r.consensus_count >= 2 ? '#facc15' : '#f87171'};padding:2px 8px;border-radius:4px">${r.consensus_bucket} (${r.consensus_count}/3)</span></td>
      <td style="padding:6px;color:${consColor}">${consIcon}</td>
    </tr>`;
  }
  html += '</tbody></table></div></div>';

  area.innerHTML = html;

  // Render charts
  renderAccuracyChart(runSummaries);
  renderMonthlyChart(results || []);
}

function renderModelBar(name, rate, mae, color) {
  const pct = rate != null ? (rate * 100).toFixed(0) : 0;
  const maeStr = mae != null ? mae.toFixed(2) : 'â€”';
  return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
    <span style="width:50px;font-size:0.8em;color:#888">${name}</span>
    <div style="flex:1;height:8px;background:#1a1a2a;border-radius:4px;overflow:hidden">
      <div style="height:100%;width:${pct}%;background:${color};border-radius:4px;transition:width 0.5s"></div>
    </div>
    <span style="width:35px;font-size:0.8em;color:${color};text-align:right;font-weight:600">${pct}%</span>
    <span style="width:50px;font-size:0.7em;color:#555;text-align:right">MAE ${maeStr}</span>
  </div>`;
}

function renderAccuracyChart(summaries) {
  if (backtestCharts['accuracy']) backtestCharts['accuracy'].destroy();
  const canvas = document.getElementById('bt-accuracy-chart');
  if (!canvas) return;

  const cities = summaries.map(s => CITIES.find(c => c.slug === s.city)?.name || s.city);
  backtestCharts['accuracy'] = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: cities,
      datasets: [
        { label: 'ECMWF', data: summaries.map(s => (s.ecmwf_match_rate*100).toFixed(1)), backgroundColor: '#4ade80', borderRadius: 4 },
        { label: 'GFS', data: summaries.map(s => (s.gfs_match_rate*100).toFixed(1)), backgroundColor: '#60a5fa', borderRadius: 4 },
        { label: 'ICON', data: summaries.map(s => (s.icon_match_rate*100).toFixed(1)), backgroundColor: '#facc15', borderRadius: 4 },
        { label: 'â‰¥2/3 Cons', data: summaries.map(s => (s.consensus2_rate*100).toFixed(1)), backgroundColor: '#a78bfa', borderRadius: 4 },
        { label: '3/3 Cons', data: summaries.map(s => s.consensus3_total > 0 ? (s.consensus3_rate*100).toFixed(1) : 0), backgroundColor: '#fb923c', borderRadius: 4 },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#888', font: { size: 10 } } } },
      scales: {
        x: { ticks: { color: '#555' }, grid: { display: false } },
        y: { min: 0, max: 100, ticks: { color: '#555', callback: v => v + '%' }, grid: { color: '#1a1a2a' } }
      }
    }
  });
}

function renderMonthlyChart(results) {
  if (backtestCharts['monthly']) backtestCharts['monthly'].destroy();
  const canvas = document.getElementById('bt-monthly-chart');
  if (!canvas) return;

  // Group by city+month
  const byCityMonth = {};
  results.forEach(r => {
    if (r.consensus_count < 2) return;
    const month = r.target_date.slice(0, 7);
    const key = `${r.city}:${month}`;
    if (!byCityMonth[key]) byCityMonth[key] = { city: r.city, month, correct: 0, total: 0 };
    byCityMonth[key].total++;
    if (r.consensus_correct) byCityMonth[key].correct++;
  });

  const months = [...new Set(Object.values(byCityMonth).map(v => v.month))].sort();
  const cityColors = { paris: '#60a5fa', london: '#4ade80', chicago: '#facc15', 'buenos-aires': '#fb923c' };

  const datasets = CITIES.map(city => ({
    label: city.name,
    data: months.map(m => {
      const v = byCityMonth[`${city.slug}:${m}`];
      return v && v.total > 0 ? +((v.correct / v.total) * 100).toFixed(1) : null;
    }),
    borderColor: cityColors[city.slug],
    backgroundColor: cityColors[city.slug] + '33',
    borderWidth: 2,
    pointRadius: 4,
    tension: 0.3,
    spanGaps: true,
  }));

  backtestCharts['monthly'] = new Chart(canvas, {
    type: 'line',
    data: { labels: months, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#888', font: { size: 10 } } } },
      scales: {
        x: { ticks: { color: '#555' }, grid: { color: '#1a1a2a' } },
        y: { min: 0, max: 100, ticks: { color: '#555', callback: v => v + '%' }, grid: { color: '#1a1a2a' } }
      }
    }
  });
}

// Init
refresh();
setInterval(refresh, 5 * 60 * 1000);
</script>
</body>
</html>
